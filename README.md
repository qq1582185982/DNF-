# DNFæ¸¸æˆä»£ç† - æœåŠ¡å™¨ç«¯å£å¤ç”¨ç‰ˆæœ¬

## ğŸ“‹ ç‰ˆæœ¬ä¿¡æ¯
- **ç‰ˆæœ¬**: v4.0 IPv6 + åŸŸåæ”¯æŒç‰ˆ
- **æ—¥æœŸ**: 2025-10-14
- **çŠ¶æ€**: âœ… å·²å®Œæˆå¹¶æµ‹è¯•é€šè¿‡
- **æ–°å¢åŠŸèƒ½**: IPv6åŒæ ˆæ”¯æŒã€åŸŸåè§£æ

## ğŸ¯ åŠŸèƒ½ç‰¹æ€§

### æ ¸å¿ƒåŠŸèƒ½
1. **IPv6åŒæ ˆæ”¯æŒ** - æœåŠ¡å™¨åŒæ—¶æ”¯æŒIPv4å’ŒIPv6å®¢æˆ·ç«¯è¿æ¥ ğŸ†•
2. **åŸŸåè§£æ** - æ¸¸æˆæœåŠ¡å™¨å’Œéš§é“æœåŠ¡å™¨å‡æ”¯æŒåŸŸåé…ç½® ğŸ†•
3. **å¤šæœåŠ¡å™¨ç«¯å£å¤ç”¨** - å•ä¸ªæœåŠ¡å™¨è¿›ç¨‹æ”¯æŒå¤šä¸ªæ¸¸æˆæœåŠ¡å™¨
4. **TCPåŠå…³é—­ä¿®å¤** - è§£å†³æ¸¸æˆé€€å‡ºå¡é¡¿é—®é¢˜
5. **æ™ºèƒ½æ—¥å¿—ç³»ç»Ÿ** - æ”¯æŒDEBUG/INFO/WARN/ERRORå››çº§æ—¥å¿—
6. **è‡ªåŠ¨æ—¥å¿—ç›®å½•** - æ—¥å¿—ç»Ÿä¸€å­˜æ”¾åœ¨`log/`ç›®å½•
7. **é…ç½®æ³¨å…¥å·¥å…·** - æ— éœ€ç¡¬ç¼–ç é…ç½®çš„å®¢æˆ·ç«¯

### æ¶æ„ä¼˜åŠ¿
```
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚  DNFéš§é“æœåŠ¡å™¨ (å•è¿›ç¨‹)          â”‚
              â”‚  tcp_tunnel_server               â”‚
              â”‚  ç›‘å¬ç«¯å£: 33223, 33224, ...     â”‚
              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â†“              â†“
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”      â”Œâ”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚ æ¸¸æˆæœåŠ¡å™¨1   â”‚      â”‚  æ¸¸æˆæœåŠ¡å™¨2   â”‚
         â”‚ 10.0.0.10    â”‚      â”‚  10.0.0.11    â”‚
         â”‚ ç«¯å£: 11011  â”‚      â”‚  ç«¯å£: 11011  â”‚
         â”‚       7001   â”‚      â”‚        7001   â”‚
         â”‚       10011  â”‚      â”‚        10011  â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ“ ç›®å½•ç»“æ„

```
æœåŠ¡å™¨ç«¯å£å¤ç”¨/
â”œâ”€â”€ README.md                              # æœ¬æ–‡æ¡£
â”œâ”€â”€ æœåŠ¡å™¨æºç /                             # æœåŠ¡å™¨ç«¯ä»£ç 
â”‚   â”œâ”€â”€ tcp_tunnel_server.cpp              # æœåŠ¡å™¨ä¸»ç¨‹åº
â”‚   â”œâ”€â”€ websocket_bridge.cpp               # WebSocketæ¡¥æ¥ï¼ˆå®éªŒæ€§ï¼‰
â”‚   â”œâ”€â”€ config.json                        # æœåŠ¡å™¨é…ç½®æ–‡ä»¶
â”‚   â”œâ”€â”€ build.sh                           # ç¼–è¯‘è„šæœ¬
â”‚   â””â”€â”€ Makefile                           # Makefileæ„å»ºæ–‡ä»¶
â”œâ”€â”€ å¸¦é…ç½®çš„å®¢æˆ·ç«¯æºç /                      # å®¢æˆ·ç«¯ä»£ç å’Œå·¥å…·
â”‚   â”œâ”€â”€ tcp_proxy_client_no_config.cpp     # æ— ç¡¬ç¼–ç é…ç½®å®¢æˆ·ç«¯
â”‚   â”œâ”€â”€ config_injector.cpp                # é…ç½®æ³¨å…¥å·¥å…·æºç 
â”‚   â”œâ”€â”€ 1.ç¼–è¯‘ç©ºç™½å®¢æˆ·ç«¯.ps1               # æ­¥éª¤1ï¼šç¼–è¯‘å®¢æˆ·ç«¯
â”‚   â”œâ”€â”€ 2.ç”Ÿæˆå®¢æˆ·ç«¯2è¿›åˆ¶ç¼–ç .py           # æ­¥éª¤2ï¼šç”Ÿæˆå®¢æˆ·ç«¯äºŒè¿›åˆ¶
â”‚   â”œâ”€â”€ 3.ç”Ÿæˆé…ç½®å™¨.ps1                   # æ­¥éª¤3ï¼šç¼–è¯‘é…ç½®æ³¨å…¥å·¥å…·
â”‚   â”œâ”€â”€ WinDivert.dll                      # WinDivertè¿è¡Œæ—¶
â”‚   â”œâ”€â”€ WinDivert64.sys                    # WinDiverté©±åŠ¨
â”‚   â”œâ”€â”€ windivert.h                        # WinDivertå¤´æ–‡ä»¶
â”‚   â””â”€â”€ WinDivert.lib                      # WinDivertåº“æ–‡ä»¶
â””â”€â”€ *.zip                                  # å†å²å½’æ¡£æ–‡ä»¶
```

## ğŸš€ å¿«é€Ÿå¼€å§‹

### æœåŠ¡å™¨ç«¯éƒ¨ç½² (Linux)

#### 1. ç¼–è¯‘æœåŠ¡å™¨
```bash
cd æœåŠ¡å™¨æºç /
chmod +x build.sh
./build.sh
```

æˆ–ä½¿ç”¨Makefile:
```bash
make
```

ï¼ˆå¯é€‰ï¼‰ç¼–è¯‘ WebSocket æ¡¥æ¥ï¼š
```bash
make ws-bridge       # ä»…æ„å»ºæ¡¥æ¥
# æˆ–
make ws-static       # å°è¯•é™æ€é“¾æ¥
```

#### 2. é…ç½®æœåŠ¡å™¨
ç¼–è¾‘ `config.json`:
```json
{
  "servers": [
    {
      "name": "æœåŠ¡å™¨1",
      "listen_port": 33223,
      "game_server_ip": "10.0.0.10",           // æ”¯æŒIPv4
      "max_connections": 100
    },
    {
      "name": "æœåŠ¡å™¨2",
      "listen_port": 33224,
      "game_server_ip": "2001:db8::10",        // æ”¯æŒIPv6 ğŸ†•
      "max_connections": 100
    },
    {
      "name": "æœåŠ¡å™¨3",
      "listen_port": 33225,
      "game_server_ip": "game.example.com",    // æ”¯æŒåŸŸå ğŸ†•
      "max_connections": 100
    }
  ],
  "log_level": "INFO"
}
```

#### 3. å¯åŠ¨æœåŠ¡å™¨
```bash
# å‰å°è¿è¡Œï¼ˆæ¨èæµ‹è¯•æ—¶ä½¿ç”¨ï¼‰
./dnf-tunnel-server

# åå°è¿è¡Œï¼ˆç”Ÿäº§ç¯å¢ƒï¼‰
nohup ./dnf-tunnel-server > /dev/null 2>&1 &
```

ï¼ˆå¯é€‰ï¼‰å¯åŠ¨ WebSocket æ¡¥æ¥ï¼š
```bash
./dnf-tunnel-ws-bridge           # é»˜è®¤ç›‘å¬ 33280
./dnf-tunnel-ws-bridge 18080     # æŒ‡å®šç›‘å¬ç«¯å£
```

#### 4. æŸ¥çœ‹æ—¥å¿—
```bash
tail -f log/server_log_*.txt
```

### å®¢æˆ·ç«¯éƒ¨ç½² (Windows)

#### æ–¹å¼ä¸€ï¼šä½¿ç”¨é…ç½®æ³¨å…¥å·¥å…·ï¼ˆæ¨èï¼‰

**æ­¥éª¤1**: ç¼–è¯‘ç©ºç™½å®¢æˆ·ç«¯
```powershell
cd å¸¦é…ç½®çš„å®¢æˆ·ç«¯æºç /
.\u00301.ç¼–è¯‘ç©ºç™½å®¢æˆ·ç«¯.ps1
```
ç”Ÿæˆ `tcp_proxy_client_blank.exe`

**æ­¥éª¤2**: ç”Ÿæˆå®¢æˆ·ç«¯äºŒè¿›åˆ¶ç¼–ç 
```powershell
python 2.ç”Ÿæˆå®¢æˆ·ç«¯2è¿›åˆ¶ç¼–ç .py
```
ç”Ÿæˆ `client_program_hex.txt`ï¼ˆå®¢æˆ·ç«¯çš„åå…­è¿›åˆ¶ç¼–ç ï¼‰

**æ­¥éª¤3**: ç¼–è¯‘é…ç½®æ³¨å…¥å·¥å…·
```powershell
.3.ç”Ÿæˆé…ç½®å™¨.ps1
```
ç”Ÿæˆ `config_injector.exe`

**æ­¥éª¤4**: æ³¨å…¥é…ç½®ç”Ÿæˆæœ€ç»ˆå®¢æˆ·ç«¯
```powershell
# è¯­æ³•ï¼šconfig_injector.exe ç©ºç™½å®¢æˆ·ç«¯ æ¸¸æˆæœåŠ¡å™¨IP éš§é“æœåŠ¡å™¨IP éš§é“ç«¯å£ è¾“å‡ºæ–‡ä»¶

# IPv4ç¤ºä¾‹
.config_injector.exe tcp_proxy_client_blank.exe 192.168.1.100 10.0.0.50 33223 "DNFä»£ç†å®¢æˆ·ç«¯-æœåŠ¡å™¨1.exe"

# IPv6ç¤ºä¾‹ ğŸ†•
.config_injector.exe tcp_proxy_client_blank.exe 2001:db8::100 2001:db8::50 33224 "DNFä»£ç†å®¢æˆ·ç«¯-IPv6.exe"

# åŸŸåç¤ºä¾‹ ğŸ†•
.config_injector.exe tcp_proxy_client_blank.exe game.local tunnel.example.com 33225 "DNFä»£ç†å®¢æˆ·ç«¯-åŸŸå.exe"
```

#### æ–¹å¼äºŒï¼šç›´æ¥ä¿®æ”¹æºç ç¼–è¯‘
ä¿®æ”¹ `tcp_proxy_client_no_config.cpp` ä¸­çš„é…ç½®ï¼Œç„¶åç¼–è¯‘ã€‚

#### è¿è¡Œå®¢æˆ·ç«¯
1. **å¿…é¡»ä»¥ç®¡ç†å‘˜æƒé™è¿è¡Œ**ï¼ˆå³é”®â†’ä»¥ç®¡ç†å‘˜èº«ä»½è¿è¡Œï¼‰
2. å®¢æˆ·ç«¯ä¼šè‡ªåŠ¨åœ¨ `log/` ç›®å½•ç”Ÿæˆæ—¥å¿—æ–‡ä»¶
3. é…ç½®æˆåŠŸåï¼Œå®¢æˆ·ç«¯ä¼šæ˜¾ç¤ºï¼š
```
============================================================
DNFæ¸¸æˆä»£ç†å®¢æˆ·ç«¯ v5.0 (C++ ç‰ˆæœ¬ - TCP)
============================================================

å·²è¯»å–é…ç½®:
  æ¸¸æˆæœåŠ¡å™¨: 192.168.1.100
  éš§é“æœåŠ¡å™¨: 10.0.0.50:33223

ä»£ç†å®¢æˆ·ç«¯å·²å¯åŠ¨
æŒ‰Ctrl+Cé€€å‡º...
```

## ğŸŒ IPv6 å’ŒåŸŸåæ”¯æŒ (v4.0æ–°å¢)

### IPv6 æ”¯æŒ

**æœåŠ¡å™¨ç«¯**:
- è‡ªåŠ¨å¯ç”¨IPv6åŒæ ˆç›‘å¬ï¼ˆåŒæ—¶æ¥å—IPv4å’ŒIPv6è¿æ¥ï¼‰
- æ¸¸æˆæœåŠ¡å™¨è¿æ¥æ”¯æŒIPv6åœ°å€
- æ—¥å¿—ä¸­ä¼šæ˜¾ç¤ºå®¢æˆ·ç«¯åè®®ç±»å‹ï¼ˆIPv4/IPv6ï¼‰

**å®¢æˆ·ç«¯**:
- è‡ªåŠ¨æ£€æµ‹æ¸¸æˆæœåŠ¡å™¨IPç±»å‹ï¼ˆIPv4/IPv6ï¼‰
- WinDivertè¿‡æ»¤å™¨è‡ªåŠ¨é€‚é…åè®®
- æ”¯æŒè¿æ¥IPv6éš§é“æœåŠ¡å™¨

**é…ç½®ç¤ºä¾‹**:
```json
// æœåŠ¡å™¨é…ç½®
{
  "game_server_ip": "2001:db8::1",      // IPv6åœ°å€
  "listen_port": 33223
}

// å®¢æˆ·ç«¯é…ç½®ï¼ˆé€šè¿‡config_injectoræ³¨å…¥ï¼‰
{
  "game_server_ip": "2001:db8::100",
  "tunnel_server_ip": "2001:db8::50",
  "tunnel_port": 33223
}
```

### åŸŸåè§£æ

**æ”¯æŒåœºæ™¯**:
- æ¸¸æˆæœåŠ¡å™¨ä½¿ç”¨åŸŸåï¼ˆæœåŠ¡å™¨ç«¯ï¼‰
- éš§é“æœåŠ¡å™¨ä½¿ç”¨åŸŸåï¼ˆå®¢æˆ·ç«¯ï¼‰
- è‡ªåŠ¨DNSè§£æï¼Œæ”¯æŒå¤šåœ°å€è½®è¯¢

**é…ç½®ç¤ºä¾‹**:
```json
// æœåŠ¡å™¨é…ç½®
{
  "game_server_ip": "game.example.com",  // åŸŸå
  "listen_port": 33223
}

// å®¢æˆ·ç«¯é…ç½®
{
  "game_server_ip": "game.local",           // æ¸¸æˆæœåŠ¡å™¨åŸŸå
  "tunnel_server_ip": "tunnel.example.com", // éš§é“æœåŠ¡å™¨åŸŸå
  "tunnel_port": 33223
}
```

**DNSè§£æç‰¹æ€§**:
- ä½¿ç”¨ `getaddrinfo()` å®ç°è·¨å¹³å°DNSè§£æ
- è‡ªåŠ¨å°è¯•æ‰€æœ‰è§£æç»“æœï¼ˆæ”¯æŒå¤šIPè½®è¯¢ï¼‰
- å¤±è´¥è‡ªåŠ¨åˆ‡æ¢ä¸‹ä¸€ä¸ªIPåœ°å€
- æ”¯æŒIPv4å’ŒIPv6æ··åˆè§£æ

### æ··åˆé…ç½®ç¤ºä¾‹

```json
{
  "servers": [
    {
      "name": "æœ¬åœ°æœåŠ¡å™¨",
      "listen_port": 33223,
      "game_server_ip": "192.168.1.100",     // IPv4
      "max_connections": 100
    },
    {
      "name": "è¿œç¨‹æœåŠ¡å™¨",
      "listen_port": 33224,
      "game_server_ip": "game.example.com",  // åŸŸå
      "max_connections": 100
    },
    {
      "name": "IPv6æœåŠ¡å™¨",
      "listen_port": 33225,
      "game_server_ip": "2001:db8::10",      // IPv6
      "max_connections": 100
    }
  ],
  "log_level": "INFO"
}
```

## ğŸ”§ é…ç½®è¯´æ˜

### æœåŠ¡å™¨é…ç½® (config.json)

```json
{
  "listen_ports": [33223, 33224],           // éš§é“ç›‘å¬ç«¯å£åˆ—è¡¨
  "log_level": "INFO",                      // æ—¥å¿—çº§åˆ«: DEBUG/INFO/WARN/ERROR
  "servers": [                              // æ¸¸æˆæœåŠ¡å™¨åˆ—è¡¨
    {
      "name": "æœåŠ¡å™¨1",                     // æœåŠ¡å™¨åç§°ï¼ˆæ˜¾ç¤ºåœ¨æ—¥å¿—ä¸­ï¼‰
      "game_server_ip": "10.0.0.10",        // æ¸¸æˆæœåŠ¡å™¨IP
      "ports": [11011, 7001, 10011]         // æ¸¸æˆç«¯å£åˆ—è¡¨
    }
  ]
}
```

### å®¢æˆ·ç«¯é…ç½®

å®¢æˆ·ç«¯é…ç½®é€šè¿‡ `config_injector.exe` æ³¨å…¥åˆ°å¯æ‰§è¡Œæ–‡ä»¶æœ«å°¾ï¼š
- **game_server_ip**: æ¸¸æˆæœåŠ¡å™¨IPï¼ˆå®¢æˆ·ç«¯æœ¬åœ°ä¼ªè£…çš„IPï¼‰
- **tunnel_server_ip**: éš§é“æœåŠ¡å™¨å…¬ç½‘IP
- **tunnel_port**: éš§é“æœåŠ¡å™¨ç«¯å£ï¼ˆå¯¹åº” config.json ä¸­çš„ listen_portsï¼‰

## ğŸ“Š æ—¥å¿—ç³»ç»Ÿ

### æ—¥å¿—çº§åˆ«è¯´æ˜

| çº§åˆ«  | ç”¨é€”                                           | ç¤ºä¾‹                                  |
|-------|------------------------------------------------|---------------------------------------|
| DEBUG | è¯¦ç»†è°ƒè¯•ä¿¡æ¯ï¼ˆåŒ…åºåˆ—å·ã€hex dumpç­‰ï¼‰           | TCPåŒ…è¯¦æƒ…ã€çª—å£å¤§å°ã€ACKç¡®è®¤          |
| INFO  | å…³é”®ä¸šåŠ¡äº‹ä»¶                                   | è¿æ¥å»ºç«‹ã€è¿æ¥æ–­å¼€ã€å¯åŠ¨/åœæ­¢          |
| WARN  | è­¦å‘Šä¿¡æ¯ï¼ˆä¸å½±å“è¿è¡Œï¼‰                         | çª—å£é˜»å¡ã€ç¼“å†²åŒºè¿‡å¤§                   |
| ERROR | é”™è¯¯ä¿¡æ¯ï¼ˆå½±å“è¿è¡Œï¼‰                           | è¿æ¥å¤±è´¥ã€socketé”™è¯¯                   |

### INFOçº§åˆ«æ—¥å¿—ç¤ºä¾‹ï¼ˆé»˜è®¤ï¼‰

**æœåŠ¡å™¨ç«¯**:
```
2025-10-14 12:00:00.001 [INFO] æœåŠ¡å™¨é…ç½®åŠ è½½å®Œæˆ
2025-10-14 12:00:00.002 [INFO] ç›‘å¬ç«¯å£: 33223, 33224
2025-10-14 12:00:00.003 [INFO] æœåŠ¡å™¨å·²å¯åŠ¨ï¼Œç­‰å¾…è¿æ¥...
2025-10-14 12:00:10.123 [INFO] [è¿æ¥1] æ–°å®¢æˆ·ç«¯è¿æ¥ 127.0.0.1:45678 -> ç«¯å£10011
2025-10-14 12:00:10.125 [INFO] [è¿æ¥1] âœ“ è¿æ¥åˆ°æ¸¸æˆæœåŠ¡å™¨ 10.0.0.10:10011
```

**å®¢æˆ·ç«¯**:
```
2025-10-14 12:00:10.100 [INFO] ä»£ç†å®¢æˆ·ç«¯å·²å¯åŠ¨
2025-10-14 12:00:10.200 [INFO] [è¿æ¥1] âœ“ TCPè¿æ¥å·²å»ºç«‹ (æ”¶åˆ°ACK=12346)
```

### DEBUGçº§åˆ«æ—¥å¿—
åŒ…å«æ‰€æœ‰è¯¦ç»†ä¿¡æ¯ï¼Œç”¨äºé—®é¢˜è¯Šæ–­ï¼š
```bash
# ä¿®æ”¹æœåŠ¡å™¨ config.json
{
  "log_level": "DEBUG"
}

# å®¢æˆ·ç«¯éœ€è¦é‡æ–°ç¼–è¯‘æˆ–ä¿®æ”¹æºç 
```

## ğŸ› ï¸ æŠ€æœ¯ç»†èŠ‚

### æœåŠ¡å™¨ç«¯å£å¤ç”¨å®ç°

**ç«¯å£åˆ°æœåŠ¡å™¨çš„æ˜ å°„**:
```cpp
// config.json é…ç½®:
"listen_ports": [33223, 33224]
"servers": [
  {"game_server_ip": "10.0.0.10", "ports": [11011, 7001, 10011]},
  {"game_server_ip": "10.0.0.11", "ports": [11011, 7001, 10011]}
]

// æ˜ å°„å…³ç³»:
éš§é“ç«¯å£33223 â†’ æœåŠ¡å™¨ç´¢å¼•0 â†’ 10.0.0.10
éš§é“ç«¯å£33224 â†’ æœåŠ¡å™¨ç´¢å¼•1 â†’ 10.0.0.11
```

**è¿æ¥æµç¨‹**:
1. å®¢æˆ·ç«¯è¿æ¥éš§é“ç«¯å£ï¼ˆå¦‚33223ï¼‰
2. å‘é€æ¡æ‰‹åŒ…ï¼š`conn_id(4å­—èŠ‚) + game_port(2å­—èŠ‚)`
3. æœåŠ¡å™¨æ ¹æ®éš§é“ç«¯å£ç¡®å®šæ¸¸æˆæœåŠ¡å™¨IP
4. æœåŠ¡å™¨è¿æ¥ `game_server_ip:game_port`
5. å»ºç«‹åŒå‘è½¬å‘éš§é“

### TCPåŠå…³é—­æœºåˆ¶

è§£å†³æ¸¸æˆé€€å‡ºå¡é¡¿é—®é¢˜ï¼š

```cpp
// æ¸¸æˆæœåŠ¡å™¨å‘é€FINæ—¶
if (n == 0) {
    // åªå…³é—­æ¸¸æˆâ†’å®¢æˆ·ç«¯æ–¹å‘
    shutdown(game_fd, SHUT_RD);
    // ä¿æŒå®¢æˆ·ç«¯â†’æ¸¸æˆæ–¹å‘å¼€å¯ï¼Œå…è®¸å®¢æˆ·ç«¯å‘é€å‰©ä½™æ•°æ®
}

// å®¢æˆ·ç«¯â†’æ¸¸æˆè½¬å‘æ£€æµ‹åˆ°EPIPEæ—¶
if (errno == EPIPE) {
    // æ­¤æ—¶æ‰å®‰å…¨å…³é—­æ•´ä¸ªè¿æ¥
    running = false;
}
```

### é…ç½®æ³¨å…¥åŸç†

å®¢æˆ·ç«¯é…ç½®ä»¥JSONæ ¼å¼è¿½åŠ åˆ°exeæ–‡ä»¶æœ«å°¾ï¼š

```
[EXEæ–‡ä»¶å†…å®¹]
[CONFIG_START]{"game_server_ip":"192.168.1.100","tunnel_server_ip":"10.0.0.50","tunnel_port":33223}[CONFIG_END]
```

å®¢æˆ·ç«¯å¯åŠ¨æ—¶ï¼š
1. è·å–è‡ªèº«exeè·¯å¾„
2. ä»æ–‡ä»¶æœ«å°¾è¯»å–8KB
3. æœç´¢ `[CONFIG_START]` å’Œ `[CONFIG_END]` æ ‡è®°
4. æå–ä¸­é—´çš„JSONé…ç½®
5. è§£æå¹¶åº”ç”¨é…ç½®

## ğŸ› æ•…éšœæ’æŸ¥

### å¸¸è§é—®é¢˜

**1. å®¢æˆ·ç«¯æç¤º"éœ€è¦ç®¡ç†å‘˜æƒé™"**
```
è§£å†³æ–¹æ¡ˆï¼šå³é”®ç¨‹åº â†’ ä»¥ç®¡ç†å‘˜èº«ä»½è¿è¡Œ
åŸå› ï¼šWinDivertéœ€è¦ç®¡ç†å‘˜æƒé™åŠ è½½é©±åŠ¨
```

**2. å®¢æˆ·ç«¯æç¤º"WinDivertæ‰“å¼€å¤±è´¥"**
```
é”™è¯¯87ï¼šè¿‡æ»¤å™¨è¯­æ³•é”™è¯¯
  â†’ æ£€æŸ¥æ¸¸æˆæœåŠ¡å™¨IPé…ç½®æ˜¯å¦æ­£ç¡®

å…¶ä»–é”™è¯¯ï¼š
  â†’ ç¡®è®¤WinDivert.dllå’ŒWinDivert64.sysåœ¨åŒç›®å½•
  â†’ ä»¥ç®¡ç†å‘˜æƒé™è¿è¡Œ
  â†’ æ£€æŸ¥æ€æ¯’è½¯ä»¶æ˜¯å¦æ‹¦æˆª
```

**3. æœåŠ¡å™¨æ—¥å¿—æ˜¾ç¤º"è¿æ¥åˆ°æ¸¸æˆæœåŠ¡å™¨å¤±è´¥"**
```
æ£€æŸ¥é¡¹ï¼š
  âœ“ æ¸¸æˆæœåŠ¡å™¨IPæ˜¯å¦æ­£ç¡®
  âœ“ æ¸¸æˆç«¯å£æ˜¯å¦å¼€æ”¾
  âœ“ ç½‘ç»œè¿é€šæ€§ï¼šping game_server_ip
  âœ“ é˜²ç«å¢™è§„åˆ™
```

**4. æ¸¸æˆé€€å‡ºä»ç„¶å¡é¡¿**
```
æ£€æŸ¥ï¼š
  âœ“ æœåŠ¡å™¨æ˜¯å¦ä½¿ç”¨äº†TCPåŠå…³é—­ä¿®å¤ç‰ˆæœ¬
  âœ“ æŸ¥çœ‹æœåŠ¡å™¨æ—¥å¿—æ˜¯å¦æœ‰"æ‰§è¡ŒåŠå…³é—­"å­—æ ·
  âœ“ æ£€æŸ¥æ˜¯å¦æœ‰"å‘é€åˆ°æ¸¸æˆæœåŠ¡å™¨å¤±è´¥"é”™è¯¯
```

### æ—¥å¿—åˆ†æ

**æŸ¥çœ‹è¿æ¥å»ºç«‹è¿‡ç¨‹**:
```bash
# æœåŠ¡å™¨ç«¯
grep "æ–°å®¢æˆ·ç«¯è¿æ¥\|è¿æ¥åˆ°æ¸¸æˆæœåŠ¡å™¨" log/server_log_*.txt

# å®¢æˆ·ç«¯
grep "TCPè¿æ¥å·²å»ºç«‹" log/client_log_*.txt
```

**æŸ¥çœ‹é”™è¯¯ä¿¡æ¯**:
```bash
# æœåŠ¡å™¨ç«¯
grep "\[ERROR\]\|\[WARN\]" log/server_log_*.txt

# å®¢æˆ·ç«¯
grep "\[ERROR\]\|\[WARN\]" log/client_log_*.txt
```

**åˆ†æé€€å‡ºæµç¨‹**:
```bash
grep "FIN\|åŠå…³é—­\|æ–­å¼€" log/server_log_*.txt
```

## ğŸ“ˆ æ€§èƒ½ä¼˜åŒ–

### æœåŠ¡å™¨ç«¯
- **TCP_NODELAY**: ç¦ç”¨Nagleç®—æ³•ï¼Œé™ä½å»¶è¿Ÿ
- **çº¿ç¨‹æ± **: æ¯ä¸ªè¿æ¥ä½¿ç”¨ç‹¬ç«‹çš„è½¬å‘çº¿ç¨‹å¯¹
- **ç¼“å†²åŒº**: 4KBæ¥æ”¶ç¼“å†²åŒº
- **æ—¥å¿—åˆ·æ–°**: æ¯æ¡æ—¥å¿—ç«‹å³åˆ·æ–°ï¼Œç¡®ä¿æ•°æ®ä¸ä¸¢å¤±

### å®¢æˆ·ç«¯
- **WinDivertä¼˜å…ˆçº§**: 1000ï¼ˆé«˜ä¼˜å…ˆçº§ï¼‰
- **çª—å£ç®¡ç†**: æ ¹æ®æ¸¸æˆç«¯å£è‡ªé€‚åº”çª—å£å¤§å°
  - ç«¯å£10011: 245å­—èŠ‚
  - ç«¯å£7001: 228å­—èŠ‚
  - å…¶ä»–ç«¯å£: 229å­—èŠ‚
- **çª—å£æ¢æµ‹**: å½“æ¸¸æˆçª—å£ä¸º0æ—¶ï¼Œæ¯ç§’å‘é€æ¢æµ‹åŒ…

## ğŸ” å®‰å…¨å»ºè®®

1. **ç”Ÿäº§ç¯å¢ƒ**:
   - ä½¿ç”¨é˜²ç«å¢™é™åˆ¶éš§é“ç«¯å£è®¿é—®
   - é…ç½®æ—¥å¿—çº§åˆ«ä¸ºINFOæˆ–WARN
   - å®šæœŸæ¸…ç†æ—¥å¿—æ–‡ä»¶
   - ç›‘æ§æœåŠ¡å™¨èµ„æºä½¿ç”¨

2. **æ—¥å¿—ç®¡ç†**:
   ```bash
   # è‡ªåŠ¨æ¸…ç†7å¤©å‰çš„æ—¥å¿—
   find log/ -name "*.txt" -mtime +7 -delete

   # æ—¥å¿—è½®è½¬ï¼ˆå¯é€‰ï¼‰
   logrotate /etc/logrotate.d/dnf-tunnel
   ```

3. **è¿›ç¨‹ç®¡ç†**:
   ```bash
   # ä½¿ç”¨systemdç®¡ç†ï¼ˆæ¨èï¼‰
   sudo systemctl enable dnf-tunnel
   sudo systemctl start dnf-tunnel

   # æˆ–ä½¿ç”¨supervisor
   ```

## ğŸ“ å˜æ›´å†å²

### v4.0 (2025-10-14)
- âœ¨ **æ–°å¢ï¼šIPv6åŒæ ˆæ”¯æŒ** - æœåŠ¡å™¨åŒæ—¶æ”¯æŒIPv4/IPv6å®¢æˆ·ç«¯
- âœ¨ **æ–°å¢ï¼šåŸŸåè§£æ** - æ¸¸æˆæœåŠ¡å™¨å’Œéš§é“æœåŠ¡å™¨æ”¯æŒåŸŸåé…ç½®
- ğŸ”§ æ”¹è¿›ï¼šä½¿ç”¨ `getaddrinfo()` æ›¿ä»£ `inet_pton()` å®ç°çµæ´»åœ°å€è§£æ
- ğŸ”§ æ”¹è¿›ï¼šWinDivertè¿‡æ»¤å™¨è‡ªåŠ¨é€‚é…IPv4/IPv6
- ğŸ”§ æ”¹è¿›ï¼šæœåŠ¡å™¨ç›‘å¬ä½¿ç”¨ `sockaddr_in6` åŒæ ˆæ¨¡å¼
- ğŸ“ æ–‡æ¡£ï¼šæ·»åŠ IPv6å’ŒåŸŸåé…ç½®ç¤ºä¾‹
- âš¡ æ€§èƒ½ï¼šDNSè§£ææ”¯æŒå¤šåœ°å€è‡ªåŠ¨è½®è¯¢

### v3.3 (2025-10-14)
- âœ¨ æ–°å¢ï¼šå¤šæœåŠ¡å™¨ç«¯å£å¤ç”¨æ¶æ„
- âœ¨ æ–°å¢ï¼šæ™ºèƒ½æ—¥å¿—çº§åˆ«ç³»ç»Ÿï¼ˆDEBUG/INFO/WARN/ERRORï¼‰
- âœ¨ æ–°å¢ï¼šè‡ªåŠ¨æ—¥å¿—ç›®å½•ï¼ˆlog/ï¼‰
- âœ¨ æ–°å¢ï¼šé…ç½®æ³¨å…¥å·¥å…·ï¼Œæ— éœ€ç¡¬ç¼–ç 
- ğŸ› ä¿®å¤ï¼šTCPåŠå…³é—­æœºåˆ¶
- ğŸ› ä¿®å¤ï¼šæ¸¸æˆé€€å‡ºå¡é¡¿é—®é¢˜
- ğŸ“ ä¼˜åŒ–ï¼šæ—¥å¿—è¾“å‡ºç®€æ´æ¸…æ™°

### v3.2 (2025-10-13)
- ğŸ› ä¿®å¤ï¼šTCPåŠå…³é—­å®ç°
- ğŸ“ æ–°å¢ï¼šè¯¦ç»†é”™è¯¯æ—¥å¿—

### v3.1 åŠæ›´æ—©ç‰ˆæœ¬
- è§ä¸»ç›®å½• README.md

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [ä¸»README](../README.md) - TCPåŠå…³é—­ä¿®å¤è¯¦ç»†è¯´æ˜
- [æ¶æ„æ–‡æ¡£](../æ–‡æ¡£/ARCHITECTURE.md) - ç³»ç»Ÿæ¶æ„è®¾è®¡
- [æµ‹è¯•æ—¥å¿—](../æµ‹è¯•æ—¥å¿—/) - å®é™…æµ‹è¯•æ—¥å¿—å’Œåˆ†æ

## ğŸ“ æ”¯æŒ

é‡åˆ°é—®é¢˜ï¼Ÿ
1. æŸ¥çœ‹ [æ•…éšœæ’æŸ¥](#æ•…éšœæ’æŸ¥) ç« èŠ‚
2. æ£€æŸ¥æ—¥å¿—æ–‡ä»¶ï¼ˆ`log/` ç›®å½•ï¼‰
3. æäº¤Issueå¹¶é™„å¸¦æ—¥å¿—æ–‡ä»¶

## ğŸ“œ è®¸å¯è¯

æœ¬é¡¹ç›®ä»…ä¾›å­¦ä¹ å’Œç ”ç©¶ä½¿ç”¨ã€‚

---

**æœ€åæ›´æ–°**: 2025-10-14
**ç‰ˆæœ¬**: v4.0 IPv6 + åŸŸåæ”¯æŒç‰ˆ
**çŠ¶æ€**: âœ… ç”Ÿäº§å°±ç»ª

## ğŸ” æŠ€æœ¯äº®ç‚¹

### IPv6åŒæ ˆå®ç°
```cpp
// æœåŠ¡å™¨ç›‘å¬ - IPv6åŒæ ˆ
listen_fd = socket(AF_INET6, SOCK_STREAM, 0);
int v6only = 0;
setsockopt(listen_fd, IPPROTO_IPV6, IPV6_V6ONLY, &v6only, sizeof(v6only));
// ç°åœ¨å¯ä»¥åŒæ—¶æ¥å—IPv4å’ŒIPv6è¿æ¥
```

### åŸŸåè§£æå®ç°
```cpp
// ä½¿ç”¨getaddrinfoæ”¯æŒåŸŸå/IPv4/IPv6
struct addrinfo hints{}, *result = nullptr;
hints.ai_family = AF_UNSPEC;      // å…è®¸IPv4æˆ–IPv6
hints.ai_socktype = SOCK_STREAM;
getaddrinfo(hostname, port_str, &hints, &result);

// è‡ªåŠ¨å°è¯•æ‰€æœ‰è§£æç»“æœ
for (rp = result; rp != nullptr; rp = rp->ai_next) {
    fd = socket(rp->ai_family, rp->ai_socktype, rp->ai_protocol);
    if (connect(fd, rp->ai_addr, rp->ai_addrlen) == 0) {
        break;  // è¿æ¥æˆåŠŸ
    }
}
```

### WinDivertåè®®è‡ªé€‚åº”
```cpp
// å®¢æˆ·ç«¯è‡ªåŠ¨æ£€æµ‹IPç±»å‹
bool is_ipv6 = (game_server_ip.find(':') != string::npos);
string filter = is_ipv6
    ? "ipv6.DstAddr == " + game_server_ip  // IPv6è¿‡æ»¤å™¨
    : "ip.DstAddr == " + game_server_ip;    // IPv4è¿‡æ»¤å™¨
```

## ğŸ§ª WebSocket æ¡¥æ¥ï¼ˆå®éªŒæ€§ï¼‰

ä¸ºé€‚é… HTTP(S)/åå‘ä»£ç†/ç»Ÿä¸€ 80/443 ç«¯å£ï¼Œé¡¹ç›®æä¾›ä¸€ä¸ªç‹¬ç«‹çš„ WebSocket æ¡¥æ¥è¿›ç¨‹ï¼Œå°† WebSocket(Binary) æµé‡æ¡¥æ¥åˆ°æœ¬æœº dnf-tunnel-server çš„åŸç”Ÿç«¯å£ã€‚

- è¿›ç¨‹ï¼šdnf-tunnel-ws-bridgeï¼ˆç‹¬ç«‹äºŒè¿›åˆ¶ï¼‰
- é»˜è®¤ç›‘å¬ï¼š33280ï¼ˆIPv4/IPv6 åŒæ ˆï¼‰
- è·¯å¾„æ˜ å°„ï¼š/dnf/<port> â†’ 127.0.0.1:<port>ï¼ˆæœªæŒ‡å®šç«¯å£é»˜è®¤ 33223ï¼‰
- å­åè®®ï¼šdnf-tunnel-v1ï¼ˆå¯é€‰ï¼‰

ç¼–è¯‘ï¼š
```
cd æœåŠ¡å™¨æºç /
make ws-bridge        # å¸¸è§„åŠ¨æ€ç¼–è¯‘
# æˆ–
make ws-static        # å°è¯•é™æ€é“¾æ¥ï¼ˆç³»ç»Ÿéœ€æ”¯æŒï¼‰
```

è¿è¡Œï¼š
```
./dnf-tunnel-ws-bridge            # ç›‘å¬ 33280
# æˆ–æŒ‡å®šç«¯å£
./dnf-tunnel-ws-bridge 18080
```

Nginx åä»£ç¤ºä¾‹ï¼š
```
upstream dnf_tunnel_ws { server 127.0.0.1:33280; }
server {
  listen 443 ssl http2;
  server_name tunnel.example.com;
  ssl_certificate     /path/fullchain.pem;
  ssl_certificate_key /path/privkey.pem;

  location /dnf {
    proxy_http_version 1.1;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection "Upgrade";
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_read_timeout 3600s;
    proxy_send_timeout 3600s;
    proxy_pass http://dnf_tunnel_ws;
  }
}
```

æ³¨æ„ï¼š
- æ¡¥æ¥å±‚ä¸æ”¹å˜ç°æœ‰äºŒè¿›åˆ¶åè®®ï¼›å®¢æˆ·ç«¯éœ€ä»¥ WebSocket Binary å¸§æ‰¿è½½åŸæ¶ˆæ¯ã€‚
- é¦–æœŸä¸ºâ€œæ¯è¿æ¥ä¸€æ¡ WS è¿æ¥â€çš„å…¼å®¹æ¨¡å¼ï¼›åç»­å¯åœ¨ WS å†…å¤ç”¨å¤šä¸ª conn_idã€‚
- TLS ç”±åå‘ä»£ç†è´Ÿè´£ï¼ˆæ¨è WSS 443ï¼‰ã€‚

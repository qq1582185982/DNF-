# DNF游戏代理 - 服务器端口复用版本

## 📋 版本信息
- **版本**: v3.3 多服务器端口复用版
- **日期**: 2025-10-14
- **状态**: ✅ 已完成并测试通过

## 🎯 功能特性

### 核心功能
1. **多服务器端口复用** - 单个服务器进程支持多个游戏服务器
2. **TCP半关闭修复** - 解决游戏退出卡顿问题
3. **智能日志系统** - 支持DEBUG/INFO/WARN/ERROR四级日志
4. **自动日志目录** - 日志统一存放在`log/`目录
5. **配置注入工具** - 无需硬编码配置的客户端

### 架构优势
```
              ┌──────────────────────────────────┐
              │  DNF隧道服务器 (单进程)          │
              │  tcp_tunnel_server               │
              │  监听端口: 33223, 33224, ...     │
              └──────────────────────────────────┘
                     ↓              ↓
         ┌───────────┴──┐      ┌───┴────────────┐
         │ 游戏服务器1   │      │  游戏服务器2   │
         │ 10.0.0.10    │      │  10.0.0.11    │
         │ 端口: 11011  │      │  端口: 11011  │
         │       7001   │      │        7001   │
         │       10011  │      │        10011  │
         └──────────────┘      └────────────────┘
```

## 📁 目录结构

```
服务器端口复用/
├── README.md                              # 本文档
├── 服务器源码/                             # 服务器端代码
│   ├── tcp_tunnel_server.cpp              # 服务器主程序
│   ├── config.json                        # 服务器配置文件
│   ├── build.sh                           # 编译脚本
│   └── Makefile                           # Makefile构建文件
├── 带配置的客户端源码/                      # 客户端代码和工具
│   ├── tcp_proxy_client_no_config.cpp     # 无硬编码配置客户端
│   ├── config_injector.cpp                # 配置注入工具源码
│   ├── 1.编译空白客户端.ps1               # 步骤1：编译客户端
│   ├── 2.生成客户端2进制编码.py           # 步骤2：生成客户端二进制
│   ├── 3.生成配置器.ps1                   # 步骤3：编译配置注入工具
│   ├── WinDivert.dll                      # WinDivert运行时
│   ├── WinDivert64.sys                    # WinDivert驱动
│   ├── windivert.h                        # WinDivert头文件
│   └── WinDivert.lib                      # WinDivert库文件
└── *.zip                                  # 历史归档文件
```

## 🚀 快速开始

### 服务器端部署 (Linux)

#### 1. 编译服务器
```bash
cd 服务器源码/
chmod +x build.sh
./build.sh
```

或使用Makefile:
```bash
make
```

#### 2. 配置服务器
编辑 `config.json`:
```json
{
  "listen_ports": [33223, 33224],
  "log_level": "INFO",
  "servers": [
    {
      "name": "服务器1",
      "game_server_ip": "10.0.0.10",
      "ports": [11011, 7001, 10011]
    },
    {
      "name": "服务器2",
      "game_server_ip": "10.0.0.11",
      "ports": [11011, 7001, 10011]
    }
  ]
}
```

#### 3. 启动服务器
```bash
# 前台运行（推荐测试时使用）
./dnf-tunnel-server

# 后台运行（生产环境）
nohup ./dnf-tunnel-server > /dev/null 2>&1 &
```

#### 4. 查看日志
```bash
tail -f log/server_log_*.txt
```

### 客户端部署 (Windows)

#### 方式一：使用配置注入工具（推荐）

**步骤1**: 编译空白客户端
```powershell
cd 带配置的客户端源码/
.\1.编译空白客户端.ps1
```
生成 `tcp_proxy_client_blank.exe`

**步骤2**: 生成客户端二进制编码
```powershell
python 2.生成客户端2进制编码.py
```
生成 `client_program_hex.txt`（客户端的十六进制编码）

**步骤3**: 编译配置注入工具
```powershell
.\3.生成配置器.ps1
```
生成 `config_injector.exe`

**步骤4**: 注入配置生成最终客户端
```powershell
# 语法：config_injector.exe <空白客户端> <游戏服务器IP> <隧道服务器IP> <隧道端口> <输出文件>
.\config_injector.exe tcp_proxy_client_blank.exe 192.168.1.100 10.0.0.50 33223 "DNF代理客户端-服务器1.exe"
.\config_injector.exe tcp_proxy_client_blank.exe 192.168.1.101 10.0.0.50 33224 "DNF代理客户端-服务器2.exe"
```

#### 方式二：直接修改源码编译
修改 `tcp_proxy_client_no_config.cpp` 中的配置，然后编译。

#### 运行客户端
1. **必须以管理员权限运行**（右键→以管理员身份运行）
2. 客户端会自动在 `log/` 目录生成日志文件
3. 配置成功后，客户端会显示：
```
============================================================
DNF游戏代理客户端 v5.0 (C++ 版本 - TCP)
============================================================

已读取配置:
  游戏服务器: 192.168.1.100
  隧道服务器: 10.0.0.50:33223

代理客户端已启动
按Ctrl+C退出...
```

## 🔧 配置说明

### 服务器配置 (config.json)

```json
{
  "listen_ports": [33223, 33224],           // 隧道监听端口列表
  "log_level": "INFO",                      // 日志级别: DEBUG/INFO/WARN/ERROR
  "servers": [                              // 游戏服务器列表
    {
      "name": "服务器1",                     // 服务器名称（显示在日志中）
      "game_server_ip": "10.0.0.10",        // 游戏服务器IP
      "ports": [11011, 7001, 10011]         // 游戏端口列表
    }
  ]
}
```

### 客户端配置

客户端配置通过 `config_injector.exe` 注入到可执行文件末尾：
- **game_server_ip**: 游戏服务器IP（客户端本地伪装的IP）
- **tunnel_server_ip**: 隧道服务器公网IP
- **tunnel_port**: 隧道服务器端口（对应 config.json 中的 listen_ports）

## 📊 日志系统

### 日志级别说明

| 级别  | 用途                                           | 示例                                  |
|-------|------------------------------------------------|---------------------------------------|
| DEBUG | 详细调试信息（包序列号、hex dump等）           | TCP包详情、窗口大小、ACK确认          |
| INFO  | 关键业务事件                                   | 连接建立、连接断开、启动/停止          |
| WARN  | 警告信息（不影响运行）                         | 窗口阻塞、缓冲区过大                   |
| ERROR | 错误信息（影响运行）                           | 连接失败、socket错误                   |

### INFO级别日志示例（默认）

**服务器端**:
```
2025-10-14 12:00:00.001 [INFO] 服务器配置加载完成
2025-10-14 12:00:00.002 [INFO] 监听端口: 33223, 33224
2025-10-14 12:00:00.003 [INFO] 服务器已启动，等待连接...
2025-10-14 12:00:10.123 [INFO] [连接1] 新客户端连接 127.0.0.1:45678 -> 端口10011
2025-10-14 12:00:10.125 [INFO] [连接1] ✓ 连接到游戏服务器 10.0.0.10:10011
```

**客户端**:
```
2025-10-14 12:00:10.100 [INFO] 代理客户端已启动
2025-10-14 12:00:10.200 [INFO] [连接1] ✓ TCP连接已建立 (收到ACK=12346)
```

### DEBUG级别日志
包含所有详细信息，用于问题诊断：
```bash
# 修改服务器 config.json
{
  "log_level": "DEBUG"
}

# 客户端需要重新编译或修改源码
```

## 🛠️ 技术细节

### 服务器端口复用实现

**端口到服务器的映射**:
```cpp
// config.json 配置:
"listen_ports": [33223, 33224]
"servers": [
  {"game_server_ip": "10.0.0.10", "ports": [11011, 7001, 10011]},
  {"game_server_ip": "10.0.0.11", "ports": [11011, 7001, 10011]}
]

// 映射关系:
隧道端口33223 → 服务器索引0 → 10.0.0.10
隧道端口33224 → 服务器索引1 → 10.0.0.11
```

**连接流程**:
1. 客户端连接隧道端口（如33223）
2. 发送握手包：`conn_id(4字节) + game_port(2字节)`
3. 服务器根据隧道端口确定游戏服务器IP
4. 服务器连接 `game_server_ip:game_port`
5. 建立双向转发隧道

### TCP半关闭机制

解决游戏退出卡顿问题：

```cpp
// 游戏服务器发送FIN时
if (n == 0) {
    // 只关闭游戏→客户端方向
    shutdown(game_fd, SHUT_RD);
    // 保持客户端→游戏方向开启，允许客户端发送剩余数据
}

// 客户端→游戏转发检测到EPIPE时
if (errno == EPIPE) {
    // 此时才安全关闭整个连接
    running = false;
}
```

### 配置注入原理

客户端配置以JSON格式追加到exe文件末尾：

```
[EXE文件内容]
[CONFIG_START]{"game_server_ip":"192.168.1.100","tunnel_server_ip":"10.0.0.50","tunnel_port":33223}[CONFIG_END]
```

客户端启动时：
1. 获取自身exe路径
2. 从文件末尾读取8KB
3. 搜索 `[CONFIG_START]` 和 `[CONFIG_END]` 标记
4. 提取中间的JSON配置
5. 解析并应用配置

## 🐛 故障排查

### 常见问题

**1. 客户端提示"需要管理员权限"**
```
解决方案：右键程序 → 以管理员身份运行
原因：WinDivert需要管理员权限加载驱动
```

**2. 客户端提示"WinDivert打开失败"**
```
错误87：过滤器语法错误
  → 检查游戏服务器IP配置是否正确

其他错误：
  → 确认WinDivert.dll和WinDivert64.sys在同目录
  → 以管理员权限运行
  → 检查杀毒软件是否拦截
```

**3. 服务器日志显示"连接到游戏服务器失败"**
```
检查项：
  ✓ 游戏服务器IP是否正确
  ✓ 游戏端口是否开放
  ✓ 网络连通性：ping game_server_ip
  ✓ 防火墙规则
```

**4. 游戏退出仍然卡顿**
```
检查：
  ✓ 服务器是否使用了TCP半关闭修复版本
  ✓ 查看服务器日志是否有"执行半关闭"字样
  ✓ 检查是否有"发送到游戏服务器失败"错误
```

### 日志分析

**查看连接建立过程**:
```bash
# 服务器端
grep "新客户端连接\|连接到游戏服务器" log/server_log_*.txt

# 客户端
grep "TCP连接已建立" log/client_log_*.txt
```

**查看错误信息**:
```bash
# 服务器端
grep "\[ERROR\]\|\[WARN\]" log/server_log_*.txt

# 客户端
grep "\[ERROR\]\|\[WARN\]" log/client_log_*.txt
```

**分析退出流程**:
```bash
grep "FIN\|半关闭\|断开" log/server_log_*.txt
```

## 📈 性能优化

### 服务器端
- **TCP_NODELAY**: 禁用Nagle算法，降低延迟
- **线程池**: 每个连接使用独立的转发线程对
- **缓冲区**: 4KB接收缓冲区
- **日志刷新**: 每条日志立即刷新，确保数据不丢失

### 客户端
- **WinDivert优先级**: 1000（高优先级）
- **窗口管理**: 根据游戏端口自适应窗口大小
  - 端口10011: 245字节
  - 端口7001: 228字节
  - 其他端口: 229字节
- **窗口探测**: 当游戏窗口为0时，每秒发送探测包

## 🔐 安全建议

1. **生产环境**:
   - 使用防火墙限制隧道端口访问
   - 配置日志级别为INFO或WARN
   - 定期清理日志文件
   - 监控服务器资源使用

2. **日志管理**:
   ```bash
   # 自动清理7天前的日志
   find log/ -name "*.txt" -mtime +7 -delete

   # 日志轮转（可选）
   logrotate /etc/logrotate.d/dnf-tunnel
   ```

3. **进程管理**:
   ```bash
   # 使用systemd管理（推荐）
   sudo systemctl enable dnf-tunnel
   sudo systemctl start dnf-tunnel

   # 或使用supervisor
   ```

## 📝 变更历史

### v3.3 (2025-10-14)
- ✨ 新增：多服务器端口复用架构
- ✨ 新增：智能日志级别系统（DEBUG/INFO/WARN/ERROR）
- ✨ 新增：自动日志目录（log/）
- ✨ 新增：配置注入工具，无需硬编码
- 🐛 修复：TCP半关闭机制
- 🐛 修复：游戏退出卡顿问题
- 📝 优化：日志输出简洁清晰

### v3.2 (2025-10-13)
- 🐛 修复：TCP半关闭实现
- 📝 新增：详细错误日志

### v3.1 及更早版本
- 见主目录 README.md

## 📚 相关文档

- [主README](../README.md) - TCP半关闭修复详细说明
- [架构文档](../文档/ARCHITECTURE.md) - 系统架构设计
- [测试日志](../测试日志/) - 实际测试日志和分析

## 📞 支持

遇到问题？
1. 查看 [故障排查](#故障排查) 章节
2. 检查日志文件（`log/` 目录）
3. 提交Issue并附带日志文件

## 📜 许可证

本项目仅供学习和研究使用。

---

**最后更新**: 2025-10-14
**版本**: v3.3 多服务器端口复用版
**状态**: ✅ 生产就绪
